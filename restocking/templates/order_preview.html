{% extends "base.html" %}
{% block content %}

<h3>👀 Order Preview — {{ supplier.name }}</h3>

<div class="card" style="max-width:800px">
  <div class="grid">
    <div><strong>Outlet:</strong> {{ outlet_name }}</div>
    <div><strong>Address:</strong> {{ address }}</div>
    <div><strong>Date of Delivery:</strong> {{ delivery_date }}</div>
    {% if supplier.phone %}
    <div><strong>To:</strong> +{{ supplier.phone }} (WhatsApp)</div>
    {% endif %}
    {% if notes %}
    <div><strong>Notes:</strong> {{ notes }}</div>
    {% endif %}
  </div>

  <h4 style="margin-top:12px">Items</h4>
  <div class="grid" style="gap:8px">
    {% for it in items %}
    <div class="row" style="justify-content:space-between">
      <div>{{ it.name }}</div>
      <div>{{ it.qty }} {{ it.unit }}</div>
    </div>
    {% endfor %}
  </div>

  <h4 style="margin-top:12px">Message (read-only)</h4>
  <pre id="wa-msg"
    style="white-space:pre-wrap; border:1px solid #ddd; border-radius:8px; padding:10px; background:#fafafa">{{ text }}</pre>

  <div class="row" style="gap:8px; margin-top:12px">
    <a href="{{ wa_url }}" target="_blank" rel="noopener">
      <button type="button" class="btn primary">📲 Send via WhatsApp</button>
    </a>
    <button type="button" class="btn" onclick="
      const el = document.getElementById('wa-msg');
      const rng = document.createRange();
      rng.selectNodeContents(el);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(rng);
      try { document.execCommand('copy'); } catch(e) {}
      sel.removeAllRanges();
      this.textContent='✅ Copied';
      setTimeout(()=>this.textContent='Copy Message', 1500);
    ">Copy Message</button>
    <a href="{{ url_for('order_form', supplier_id=supplier.id) }}?{% for key, value in form_data.items() %}{{ key }}={{ value }}&{% endfor %}" 
       class="btn">← Edit Order</a>
  </div>

  <form method="post" action="{{ url_for('save_order', supplier_id=supplier.id) }}" style="margin-top:12px;">
    <!-- Hidden fields to preserve form data -->
    <input type="hidden" name="outlet_name" value="{{ outlet_name }}">
    <input type="hidden" name="address" value="{{ address }}">
    <input type="hidden" name="notes" value="{{ notes }}">
    <input type="hidden" name="delivery_date" value="{{ delivery_date }}">
    {% for key, value in form_data.items() %}
      <input type="hidden" name="{{ key }}" value="{{ value }}">
    {% endfor %}
    <button type="submit" class="btn primary">📝 Save to History</button>
  </form>
</div>

{% endblock %}